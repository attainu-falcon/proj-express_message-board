<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/styles/styles.css">
    <title>Post</title>
</head>

<body>
    <header class="post-container">
        <button class="back" onclick="back()"></button> 
        <textarea class="post-box" placeholder="post!"></textarea>
        <div class="toolbar">
            <h2 class="topic-heading">â˜… 1</h2>
            <button class="post-button">post</button>
        </div>
    </header>
    <main class="comments-container">
        <div class="insert-comment-box" contenteditable="true" data-placeholder="Enter comment."></div>
        <!--
     --><button class="send-button">Send</button>
        <ul class="comments-list">
            <!-- <li><div class="comment-box">your comments.</div></li> -->
        </ul>
    </main>
    <script>
        document.querySelector('.post-button').addEventListener('click', function () {
            var post = document.querySelector('.post-box').value;
            var cmnt = document.querySelector('.insert-comment-box').innerText;
            let urlParams = new URLSearchParams(window.location.search)
            let id = urlParams.get('topicid')
            fetch('/createpost', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    post,
                    id
                })
            }).then(result => console.log(result)).catch(error => console.log(error))
        })

        document.querySelector('.send-button').addEventListener('click', function () {
            var cmnt = document.querySelector('.insert-comment-box').innerText;
            let urlParams = new URLSearchParams(window.location.search)
            let topicid = urlParams.get('topicid')
            let postid = urlParams.get('postid')
            fetch('/createcomment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    cmnt,
                    topicid,
                    postid
                })
            })
            // .then(res=>res.text())
            .then(result => renderCommentsCheck(result.status)).catch(error => console.log(error))
        })

        function renderCommentsCheck(status) {
            let urlParams = new URLSearchParams(window.location.search)
            if(status==200 && urlParams.has('postid')) {
                let topicid = urlParams.get('topicid')
                let postid = urlParams.get('postid')
                fetch('/commentlist?topicid='+ topicid + '&postid=' + postid)
                .then(res=>res.json())
                .then(result=>renderComments(result))
                .catch(err=>console.log(err))
                function renderComments(result) {
                    document.querySelector('.comments-list').innerHTML = ''
                    for (const cmnt of result) {
                        let li = document.createElement('li')
                        let div = document.createElement('div')
                        div.className = 'comment-box'
                        div.setAttribute('data-id', cmnt._id)
                        div.innerText = cmnt.content
                        li.appendChild(div)
                        document.querySelector('.comments-list').prepend(li)
                    }
                }
            }            
        }

        renderCommentsCheck(200)

        function back() {
            let urlParams = new URLSearchParams(window.location.search)
            // console.log(urlParams.has('post'))
            let id = urlParams.get('topicid')
            window.location.replace('/leaderboard?topicid=' + id)
        }

        fetch('/getpost' + window.location.search)
            .then(res => res.json()).then(result => renderPost(result)).catch(err => console.log(err))

        function renderPost(result) {
            console.log(result)
            document.querySelector('.post-box').value = result.content
        }

        let urlParams = new URLSearchParams(window.location.search)
        if(!urlParams.has('postid')) {
            document.querySelector('.insert-comment-box').style.display = 'none'
            document.querySelector('.send-button').style.display = 'none'
        } else {
            document.querySelector('.post-button').innerText = 'Edit'
            document.querySelector('.post-button').style.visibility = 'hidden'
            document.querySelector('.post-box').readOnly = true
        }
    </script>
</body>

</html>